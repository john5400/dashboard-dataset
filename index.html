<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard PCA + Transformación de Datos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --card-bg: #ffffff;
            --sidebar-bg: #34495e;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border: #bdc3c7;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --transform-color: #9b59b6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .dashboard-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            min-height: 90vh;
        }
        
        .dashboard-header {
            background: linear-gradient(90deg, var(--primary), var(--dark));
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.5rem;
            color: #3498db;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .logo span {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .upload-section {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .upload-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .upload-btn:hover {
            background: #219653;
            transform: translateY(-2px);
        }
        
        #fileInput {
            display: none;
        }
        
        .file-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .dashboard-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: calc(90vh - 100px);
        }
        
        .sidebar {
            background: var(--sidebar-bg);
            color: white;
            padding: 25px 20px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .menu-item {
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .menu-item:hover, .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }
        
        .menu-item i {
            width: 20px;
            text-align: center;
        }
        
        .menu-item.transform {
            border-left: 4px solid var(--transform-color);
        }
        
        .controls-section {
            margin-top: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .controls-section h3 {
            font-size: 1rem;
            margin-bottom: 15px;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .controls-section.transform {
            border-top: 3px solid var(--transform-color);
            background: rgba(155, 89, 182, 0.1);
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .control-group input, .control-group select {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .control-group select option {
            background: var(--sidebar-bg);
            color: white;
        }
        
        .calculate-btn {
            width: 100%;
            padding: 12px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .transform-btn {
            background: var(--transform-color);
        }
        
        .transform-btn:hover {
            background: #8e44ad;
        }
        
        .main-content {
            padding: 30px;
            overflow-y: auto;
            max-height: calc(90vh - 100px);
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 20px;
            border-top: 4px solid;
        }
        
        .stat-card:nth-child(1) { border-color: var(--danger); }
        .stat-card:nth-child(2) { border-color: var(--warning); }
        .stat-card:nth-child(3) { border-color: var(--success); }
        .stat-card:nth-child(4) { border-color: var(--secondary); }
        .stat-card.transform { border-color: var(--transform-color); }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
        }
        
        .stat-card:nth-child(1) .stat-icon { background: var(--danger); }
        .stat-card:nth-child(2) .stat-icon { background: var(--warning); }
        .stat-card:nth-child(3) .stat-icon { background: var(--success); }
        .stat-card:nth-child(4) .stat-icon { background: var(--secondary); }
        .stat-card.transform .stat-icon { background: var(--transform-color); }
        
        .stat-content h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-content p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-header h3 {
            font-size: 1.2rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-wrapper {
            height: 300px;
            position: relative;
        }
        
        .data-table-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: var(--light);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
        }
        
        tbody tr:hover {
            background: rgba(52, 152, 219, 0.05);
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
        
        .loading.active {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--secondary);
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .heatmap-container {
            display: grid;
            grid-template-columns: 150px repeat(auto-fit, minmax(80px, 1fr));
            gap: 5px;
            margin-top: 20px;
        }
        
        .heatmap-cell {
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .heatmap-cell.header {
            background: var(--primary);
            color: white;
            font-weight: 700;
        }
        
        .heatmap-cell.var-header {
            background: var(--dark);
            color: white;
            text-align: left;
            font-weight: 600;
        }
        
        .transform-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .badge-improved {
            background: rgba(39, 174, 96, 0.15);
            color: #27ae60;
            border: 1px solid rgba(39, 174, 96, 0.3);
        }
        
        .badge-worse {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .badge-info {
            background: rgba(52, 152, 219, 0.15);
            color: #3498db;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        
        .slider-value {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .sidebar.active {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                width: 300px;
                z-index: 100;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <div>
                    <h1>PCA Dashboard <span style="color: #9b59b6;">+ Transformación</span></h1>
                    <span>Análisis de Componentes Principales con Preprocesamiento</span>
                </div>
            </div>
            
            <div class="upload-section">
                <button class="upload-btn" id="uploadBtn">
                    <i class="fas fa-upload"></i> Subir Dataset
                </button>
                <input type="file" id="fileInput" accept=".csv">
                <div class="file-info" id="fileInfo">
                    <i class="fas fa-database"></i> Sin archivo cargado
                </div>
            </div>
        </header>
        
        <div class="dashboard-content">
            <aside class="sidebar" id="sidebar">
                <nav class="menu">
                    <div class="menu-item active" data-view="overview">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Visión General</span>
                    </div>
                    <div class="menu-item" data-view="data">
                        <i class="fas fa-database"></i>
                        <span>Datos</span>
                    </div>
                    <div class="menu-item transform" data-view="transform">
                        <i class="fas fa-magic"></i>
                        <span>Transformación</span>
                        <span class="transform-badge badge-info" id="transformStatus">OFF</span>
                    </div>
                    <div class="menu-item" data-view="analysis">
                        <i class="fas fa-calculator"></i>
                        <span>Análisis PCA</span>
                    </div>
                    <div class="menu-item" data-view="results">
                        <i class="fas fa-chart-bar"></i>
                        <span>Resultados</span>
                    </div>
                    <div class="menu-item" data-view="heatmap">
                        <i class="fas fa-fire"></i>
                        <span>Heatmap</span>
                    </div>
                </nav>
                
                <!-- Sección de Configuración PCA -->
                <div class="controls-section">
                    <h3><i class="fas fa-sliders-h"></i> Configuración PCA</h3>
                    
                    <div class="control-group">
                        <label for="nComponents">Número de Componentes:</label>
                        <input type="number" id="nComponents" min="2" max="10" value="3">
                    </div>
                    
                    <div class="control-group">
                        <label for="normalize">Normalizar Datos:</label>
                        <select id="normalize">
                            <option value="true">Sí</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    
                    <button class="calculate-btn" id="calculateBtn">
                        <i class="fas fa-calculator"></i> Calcular PCA
                    </button>
                </div>
                
                <!-- Sección de Transformación de Datos -->
                <div class="controls-section transform">
                    <h3><i class="fas fa-wand-magic-sparkles"></i> Transformación de Datos</h3>
                    
                    <div class="control-group">
                        <label for="transformType">Tipo de Transformación:</label>
                        <select id="transformType">
                            <option value="none">Sin transformación</option>
                            <option value="normalize">Normalizar (0-1)</option>
                            <option value="standardize">Estandarizar (z-score)</option>
                            <option value="log">Logarítmica (log(x+1))</option>
                            <option value="sqrt">Raíz Cuadrada</option>
                            <option value="boxcox">Box-Cox</option>
                        </select>
                    </div>
                    
                    <div class="control-group" id="boxcoxGroup" style="display: none;">
                        <label for="boxcoxLambda">Parámetro Lambda (λ):</label>
                        <div class="slider-container">
                            <input type="range" id="boxcoxLambda" min="-2" max="2" step="0.1" value="0.5">
                            <span class="slider-value" id="lambdaValue">0.5</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="imputeMissing">Valores Faltantes:</label>
                        <select id="imputeMissing">
                            <option value="none">Mantener</option>
                            <option value="mean">Media</option>
                            <option value="median">Mediana</option>
                            <option value="mode">Moda</option>
                            <option value="remove">Eliminar filas</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="outlierMethod">Outliers:</label>
                        <select id="outlierMethod">
                            <option value="none">Mantener</option>
                            <option value="iqr">Eliminar (IQR)</option>
                            <option value="zscore">Eliminar (Z-Score)</option>
                            <option value="winsorize">Winsorizar</option>
                        </select>
                    </div>
                    
                    <button class="calculate-btn transform-btn" id="transformBtn">
                        <i class="fas fa-sync-alt"></i> Aplicar Transformación
                    </button>
                    
                    <button class="calculate-btn" id="resetBtn" style="background: #7f8c8d; margin-top: 10px;">
                        <i class="fas fa-undo"></i> Restaurar Datos Originales
                    </button>
                </div>
            </aside>
            
            <main class="main-content">
                <!-- VISTA: VISIÓN GENERAL -->
                <div class="view active" id="overviewView">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="statComponents">3</h3>
                                <p>Componentes PCA</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="statVariance">0%</h3>
                                <p>Varianza Explicada</p>
                            </div>
                        </div>
                        
                        <div class="stat-card transform">
                            <div class="stat-icon">
                                <i class="fas fa-magic"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="statTransform">Ninguna</h3>
                                <p>Transformación Activa</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="statSamples">0</h3>
                                <p>Muestras</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3><i class="fas fa-chart-bar"></i> Varianza Explicada por Componente</h3>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="varianceChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3><i class="fas fa-braille"></i> Comparación Antes/Después</h3>
                                <div>
                                    <select id="compareColumn" style="padding: 5px 10px; border-radius: 4px; border: 1px solid var(--border);">
                                        <!-- Opciones generadas dinámicamente -->
                                    </select>
                                </div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="comparisonChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- VISTA: DATOS -->
                <div class="view" id="dataView">
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3><i class="fas fa-table"></i> Dataset Cargado</h3>
                            <div>
                                <button class="upload-btn" id="exportBtn" style="padding: 8px 15px; font-size: 0.9rem; margin-right: 10px;">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                                <button class="upload-btn transform-btn" id="showTransformBtn" style="padding: 8px 15px; font-size: 0.9rem;">
                                    <i class="fas fa-magic"></i> Ir a Transformación
                                </button>
                            </div>
                        </div>
                        <div id="dataTable">
                            <!-- Tabla generada dinámicamente -->
                        </div>
                    </div>
                </div>
                
                <!-- VISTA: TRANSFORMACIÓN -->
                <div class="view" id="transformView">
                    <div class="stats-grid">
                        <div class="stat-card transform">
                            <div class="stat-icon">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="currentTransform">Ninguna</h3>
                                <p>Transformación Activa</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: #e74c3c;">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="statMissing">0</h3>
                                <p>Valores Faltantes</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: #f39c12;">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="statSkewness">0.00</h3>
                                <p>Sesgo Promedio</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: #3498db;">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="statKurtosis">0.00</h3>
                                <p>Curtosis Promedio</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3><i class="fas fa-balance-scale"></i> Distribución Antes vs Después</h3>
                                <select id="distColumn" style="padding: 5px 10px; border-radius: 4px; border: 1px solid var(--border);">
                                    <!-- Opciones generadas dinámicamente -->
                                </select>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="distributionChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3><i class="fas fa-chart-area"></i> Mejora de Normalidad</h3>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="improvementChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3><i class="fas fa-list-ol"></i> Estadísticas de Transformación</h3>
                            <button class="upload-btn transform-btn" id="exportTransformedBtn" style="padding: 8px 15px; font-size: 0.9rem;">
                                <i class="fas fa-download"></i> Exportar Transformados
                            </button>
                        </div>
                        <div id="transformStatsTable">
                            <!-- Tabla generada dinámicamente -->
                        </div>
                    </div>
                </div>
                
                <!-- VISTA: ANÁLISIS PCA -->
                <div class="view" id="analysisView">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-project-diagram"></i> Matriz de Correlación</h3>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="correlationChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="data-table-container" style="margin-top: 25px;">
                        <div class="table-header">
                            <h3><i class="fas fa-calculator"></i> Estadísticas Descriptivas</h3>
                        </div>
                        <div id="statsTable">
                            <!-- Tabla generada dinámicamente -->
                        </div>
                    </div>
                </div>
                
                <!-- VISTA: RESULTADOS PCA -->
                <div class="view" id="resultsView">
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3><i class="fas fa-cube"></i> Cargas Factoriales (Loadings)</h3>
                            <span class="transform-badge badge-info" id="transformIndicator">Datos originales</span>
                        </div>
                        <div id="loadingsTable">
                            <!-- Tabla generada dinámicamente -->
                        </div>
                    </div>
                    
                    <div class="charts-grid" style="margin-top: 25px;">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3><i class="fas fa-braille"></i> Scatter Plot PCA</h3>
                                <div>
                                    <select id="scatterX" style="padding: 5px 10px; border-radius: 4px; border: 1px solid var(--border);">
                                        <option value="0">PC1</option>
                                        <option value="1">PC2</option>
                                        <option value="2">PC3</option>
                                    </select>
                                    <select id="scatterY" style="padding: 5px 10px; border-radius: 4px; border: 1px solid var(--border); margin-left: 10px;">
                                        <option value="1">PC2</option>
                                        <option value="0">PC1</option>
                                        <option value="2">PC3</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="scatterChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3><i class="fas fa-chart-line"></i> Scores por Componente</h3>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="scoresChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- VISTA: HEATMAP -->
                <div class="view" id="heatmapView">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-fire"></i> Heatmap de Cargas Factoriales</h3>
                        </div>
                        <div id="heatmapContainer">
                            <!-- Heatmap generado dinámicamente -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div class="loading" id="loadingOverlay">
        <div class="spinner"></div>
        <h3 id="loadingText">Procesando...</h3>
    </div>
    
    <div class="notification" id="notification" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Operación completada</span>
    </div>

    <script>
        // ============================================
        // CLASE TRANSFORMADOR DE DATOS
        // ============================================
        
        class DataTransformer {
            constructor() {
                this.originalData = null;
                this.transformedData = null;
                this.metadata = {
                    active: false,
                    type: 'none',
                    config: {}
                };
            }
            
            // Método para normalizar datos (0-1)
            normalizeMinMax(data) {
                if (!data || data.length === 0) return data;
                
                const cols = data[0].length;
                const normalized = [];
                const mins = [];
                const maxs = [];
                
                // Calcular min y max por columna
                for (let j = 0; j < cols; j++) {
                    let min = Infinity;
                    let max = -Infinity;
                    for (let i = 0; i < data.length; i++) {
                        const val = data[i][j];
                        if (val < min) min = val;
                        if (val > max) max = val;
                    }
                    mins.push(min);
                    maxs.push(max);
                }
                
                // Aplicar normalización
                for (let i = 0; i < data.length; i++) {
                    const row = [];
                    for (let j = 0; j < cols; j++) {
                        if (maxs[j] === mins[j]) {
                            row.push(0);
                        } else {
                            row.push((data[i][j] - mins[j]) / (maxs[j] - mins[j]));
                        }
                    }
                    normalized.push(row);
                }
                
                return normalized;
            }
            
            // Método para estandarizar datos (z-score)
            standardize(data) {
                if (!data || data.length === 0) return data;
                
                const cols = data[0].length;
                const standardized = [];
                const means = [];
                const stds = [];
                
                // Calcular media y desviación estándar
                for (let j = 0; j < cols; j++) {
                    let sum = 0;
                    for (let i = 0; i < data.length; i++) {
                        sum += data[i][j];
                    }
                    const mean = sum / data.length;
                    means.push(mean);
                    
                    let variance = 0;
                    for (let i = 0; i < data.length; i++) {
                        variance += Math.pow(data[i][j] - mean, 2);
                    }
                    const std = Math.sqrt(variance / (data.length - 1));
                    stds.push(std);
                }
                
                // Aplicar estandarización
                for (let i = 0; i < data.length; i++) {
                    const row = [];
                    for (let j = 0; j < cols; j++) {
                        if (stds[j] === 0) {
                            row.push(0);
                        } else {
                            row.push((data[i][j] - means[j]) / stds[j]);
                        }
                    }
                    standardized.push(row);
                }
                
                return standardized;
            }
            
            // Transformación logarítmica
            logTransform(data) {
                if (!data || data.length === 0) return data;
                
                const transformed = [];
                for (let i = 0; i < data.length; i++) {
                    const row = data[i].map(val => {
                        // Aplicar log(x + 1) para evitar problemas con ceros
                        return Math.log(val + 1);
                    });
                    transformed.push(row);
                }
                
                return transformed;
            }
            
            // Transformación raíz cuadrada
            sqrtTransform(data) {
                if (!data || data.length === 0) return data;
                
                const transformed = [];
                for (let i = 0; i < data.length; i++) {
                    const row = data[i].map(val => {
                        return Math.sqrt(Math.max(val, 0));
                    });
                    transformed.push(row);
                }
                
                return transformed;
            }
            
            // Transformación Box-Cox
            boxCoxTransform(data, lambda = 0.5) {
                if (!data || data.length === 0) return data;
                
                const transformed = [];
                for (let i = 0; i < data.length; i++) {
                    const row = data[i].map(val => {
                        if (lambda === 0) {
                            return Math.log(val + 1);
                        } else {
                            return (Math.pow(val + 1, lambda) - 1) / lambda;
                        }
                    });
                    transformed.push(row);
                }
                
                return transformed;
            }
            
            // Tratamiento de valores faltantes
            imputeMissing(data, strategy = 'mean') {
                if (!data || data.length === 0) return data;
                
                const result = JSON.parse(JSON.stringify(data));
                const cols = data[0].length;
                
                for (let j = 0; j < cols; j++) {
                    // Encontrar valores válidos
                    const validValues = [];
                    for (let i = 0; i < data.length; i++) {
                        const val = data[i][j];
                        if (val !== null && val !== undefined && !isNaN(val)) {
                            validValues.push(val);
                        }
                    }
                    
                    if (validValues.length === 0) continue;
                    
                    let replacement;
                    switch(strategy) {
                        case 'mean':
                            replacement = validValues.reduce((a, b) => a + b, 0) / validValues.length;
                            break;
                        case 'median':
                            validValues.sort((a, b) => a - b);
                            replacement = validValues[Math.floor(validValues.length / 2)];
                            break;
                        case 'mode':
                            const freq = {};
                            validValues.forEach(v => freq[v] = (freq[v] || 0) + 1);
                            replacement = Object.keys(freq).reduce((a, b) => 
                                freq[a] > freq[b] ? parseFloat(a) : parseFloat(b)
                            );
                            break;
                        case 'remove':
                            // Eliminar filas con valores faltantes
                            return data.filter(row => 
                                !row.some(val => val === null || val === undefined || isNaN(val))
                            );
                        default:
                            replacement = 0;
                    }
                    
                    // Rellenar valores faltantes
                    for (let i = 0; i < data.length; i++) {
                        const val = data[i][j];
                        if (val === null || val === undefined || isNaN(val)) {
                            result[i][j] = replacement;
                        }
                    }
                }
                
                return result;
            }
            
            // Manejo de outliers
            handleOutliers(data, method = 'none', threshold = 1.5) {
                if (!data || data.length === 0 || method === 'none') return data;
                
                const cols = data[0].length;
                
                if (method === 'winsorize') {
                    // Winsorización: reemplazar outliers por percentiles
                    const winsorized = JSON.parse(JSON.stringify(data));
                    
                    for (let j = 0; j < cols; j++) {
                        const values = data.map(row => row[j]).filter(v => !isNaN(v));
                        values.sort((a, b) => a - b);
                        
                        const q1 = values[Math.floor(values.length * 0.25)];
                        const q3 = values[Math.floor(values.length * 0.75)];
                        const iqr = q3 - q1;
                        const lower = q1 - threshold * iqr;
                        const upper = q3 + threshold * iqr;
                        
                        for (let i = 0; i < data.length; i++) {
                            if (data[i][j] < lower) winsorized[i][j] = lower;
                            if (data[i][j] > upper) winsorized[i][j] = upper;
                        }
                    }
                    
                    return winsorized;
                } else {
                    // Eliminar outliers (IQR o Z-score)
                    const filtered = [];
                    
                    for (let i = 0; i < data.length; i++) {
                        let isOutlier = false;
                        
                        for (let j = 0; j < cols; j++) {
                            const colData = data.map(row => row[j]).filter(v => !isNaN(v));
                            
                            if (method === 'iqr') {
                                // Método IQR
                                colData.sort((a, b) => a - b);
                                const q1 = colData[Math.floor(colData.length * 0.25)];
                                const q3 = colData[Math.floor(colData.length * 0.75)];
                                const iqr = q3 - q1;
                                const lower = q1 - threshold * iqr;
                                const upper = q3 + threshold * iqr;
                                
                                if (data[i][j] < lower || data[i][j] > upper) {
                                    isOutlier = true;
                                    break;
                                }
                            } else if (method === 'zscore') {
                                // Método Z-score
                                const mean = colData.reduce((a, b) => a + b, 0) / colData.length;
                                const std = Math.sqrt(
                                    colData.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / colData.length
                                );
                                
                                if (std > 0) {
                                    const zscore = Math.abs((data[i][j] - mean) / std);
                                    if (zscore > threshold) {
                                        isOutlier = true;
                                        break;
                                    }
                                }
                            }
                        }
                        
                        if (!isOutlier) {
                            filtered.push(data[i]);
                        }
                    }
                    
                    return filtered;
                }
            }
            
            // Calcular estadísticas de una columna
            calculateColumnStats(data, colIndex) {
                const values = data.map(row => row[colIndex]).filter(v => v !== null && !isNaN(v));
                const n = values.length;
                
                if (n === 0) return null;
                
                // Media
                const mean = values.reduce((a, b) => a + b, 0) / n;
                
                // Desviación estándar
                const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / (n - 1);
                const std = Math.sqrt(variance);
                
                // Sesgo
                const skewness = n > 2 ? 
                    values.reduce((a, b) => a + Math.pow((b - mean) / std, 3), 0) * n / ((n - 1) * (n - 2)) : 0;
                
                // Curtosis
                const kurtosis = n > 3 ?
                    (n * (n + 1) * values.reduce((a, b) => a + Math.pow((b - mean) / std, 4), 0)) /
                    ((n - 1) * (n - 2) * (n - 3)) -
                    (3 * Math.pow(n - 1, 2)) / ((n - 2) * (n - 3)) : 0;
                
                return {
                    mean,
                    std,
                    skewness,
                    kurtosis,
                    min: Math.min(...values),
                    max: Math.max(...values),
                    q1: values.sort((a, b) => a - b)[Math.floor(n * 0.25)],
                    median: values.sort((a, b) => a - b)[Math.floor(n * 0.5)],
                    q3: values.sort((a, b) => a - b)[Math.floor(n * 0.75)],
                    n
                };
            }
            
            // Aplicar transformación completa
            transform(data, config) {
                if (!data || data.length === 0) return data;
                
                this.originalData = JSON.parse(JSON.stringify(data));
                let currentData = this.originalData;
                
                // 1. Tratar valores faltantes
                if (config.imputeMissing !== 'none') {
                    currentData = this.imputeMissing(currentData, config.imputeMissing);
                }
                
                // 2. Manejar outliers
                if (config.outlierMethod !== 'none') {
                    currentData = this.handleOutliers(currentData, config.outlierMethod);
                }
                
                // 3. Aplicar transformación principal
                switch(config.transformType) {
                    case 'normalize':
                        currentData = this.normalizeMinMax(currentData);
                        break;
                    case 'standardize':
                        currentData = this.standardize(currentData);
                        break;
                    case 'log':
                        currentData = this.logTransform(currentData);
                        break;
                    case 'sqrt':
                        currentData = this.sqrtTransform(currentData);
                        break;
                    case 'boxcox':
                        currentData = this.boxCoxTransform(currentData, config.boxcoxLambda);
                        break;
                }
                
                this.transformedData = currentData;
                this.metadata = {
                    active: config.transformType !== 'none',
                    type: config.transformType,
                    config: config,
                    statsBefore: this.calculateAllStats(this.originalData),
                    statsAfter: this.calculateAllStats(this.transformedData)
                };
                
                return this.transformedData;
            }
            
            // Calcular estadísticas para todas las columnas
            calculateAllStats(data) {
                if (!data || data.length === 0) return [];
                
                const cols = data[0].length;
                const stats = [];
                
                for (let j = 0; j < cols; j++) {
                    stats.push(this.calculateColumnStats(data, j));
                }
                
                return stats;
            }
            
            // Restaurar datos originales
            reset() {
                this.transformedData = null;
                this.metadata = {
                    active: false,
                    type: 'none',
                    config: {}
                };
                return this.originalData;
            }
        }
        
        // ============================================
        // APLICACIÓN PRINCIPAL
        // ============================================
        
        const app = {
            pca: null,
            transformer: new DataTransformer(),
            currentData: null,
            originalData: null,
            charts: {},
            
            init() {
                this.bindEvents();
                this.loadSampleData();
                this.showNotification('Dashboard PCA + Transformación cargado', 'info');
            },
            
            bindEvents() {
                // Navegación
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const view = e.currentTarget.dataset.view;
                        this.switchView(view);
                    });
                });
                
                // Subida de archivos
                document.getElementById('uploadBtn').addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });
                
                document.getElementById('fileInput').addEventListener('change', (e) => {
                    this.handleFileUpload(e.target.files[0]);
                });
                
                // Botón de transformación rápida en vista de datos
                document.getElementById('showTransformBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.switchView('transform');
                });
                
                // Exportar
                document.getElementById('exportBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.exportData();
                });
                
                // Controles de transformación
                document.getElementById('transformType').addEventListener('change', (e) => {
                    const boxcoxGroup = document.getElementById('boxcoxGroup');
                    boxcoxGroup.style.display = e.target.value === 'boxcox' ? 'block' : 'none';
                });
                
                document.getElementById('boxcoxLambda').addEventListener('input', (e) => {
                    document.getElementById('lambdaValue').textContent = e.target.value;
                });
                
                // Botones principales
                document.getElementById('transformBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.applyTransformation();
                });
                
                document.getElementById('resetBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.resetTransformation();
                });
                
                document.getElementById('exportTransformedBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.exportTransformedData();
                });
                
                // PCA
                document.getElementById('calculateBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.calculatePCA();
                });
                
                // Selectores de gráficos
                document.getElementById('compareColumn').addEventListener('change', () => {
                    this.updateComparisonChart();
                });
                
                document.getElementById('distColumn').addEventListener('change', () => {
                    this.updateDistributionChart();
                });
                
                document.getElementById('scatterX').addEventListener('change', () => this.updateScatterPlot());
                document.getElementById('scatterY').addEventListener('change', () => this.updateScatterPlot());
            },
            
            loadSampleData() {
                // Datos de ejemplo (iris dataset)
                const sampleData = {
                    variables: ['Largo_Sepalo', 'Ancho_Sepalo', 'Largo_Petalo', 'Ancho_Petalo'],
                    data: [
                        [5.1, 3.5, 1.4, 0.2],
                        [4.9, 3.0, 1.4, 0.2],
                        [4.7, 3.2, 1.3, 0.2],
                        [4.6, 3.1, 1.5, 0.2],
                        [5.0, 3.6, 1.4, 0.2],
                        [5.4, 3.9, 1.7, 0.4],
                        [4.6, 3.4, 1.4, 0.3],
                        [5.0, 3.4, 1.5, 0.2],
                        [4.4, 2.9, 1.4, 0.2],
                        [4.9, 3.1, 1.5, 0.1],
                        [5.4, 3.7, 1.5, 0.2],
                        [4.8, 3.4, 1.6, 0.2],
                        [4.8, 3.0, 1.4, 0.1],
                        [4.3, 3.0, 1.1, 0.1],
                        [5.8, 4.0, 1.2, 0.2]
                    ]
                };
                
                // Agregar algunos valores faltantes y outliers para demostración
                sampleData.data[2][1] = null; // Valor faltante
                sampleData.data[5][0] = 15.4; // Outlier
                
                this.currentData = sampleData;
                this.originalData = JSON.parse(JSON.stringify(sampleData));
                this.updateDataDisplay();
                this.showNotification('Datos de ejemplo cargados', 'info');
            },
            
            async handleFileUpload(file) {
                if (!file) return;
                
                this.showLoading('Cargando archivo...');
                
                try {
                    const text = await this.readFile(file);
                    const data = this.parseCSV(text);
                    
                    this.currentData = data;
                    this.originalData = JSON.parse(JSON.stringify(data));
                    this.updateDataDisplay();
                    
                    document.getElementById('fileInfo').innerHTML = `
                        <i class="fas fa-check-circle" style="color: #27ae60;"></i>
                        ${file.name} (${data.data.length} filas × ${data.variables.length} columnas)
                    `;
                    
                    this.showNotification(`Archivo "${file.name}" cargado`, 'success');
                    
                } catch (error) {
                    this.showNotification(`Error: ${error.message}`, 'error');
                } finally {
                    this.hideLoading();
                }
            },
            
            readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(new Error('Error leyendo archivo'));
                    reader.readAsText(file);
                });
            },
            
            parseCSV(text) {
                const lines = text.trim().split('\n');
                const variables = lines[0].split(',').map(v => v.trim());
                const data = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => {
                        const trimmed = v.trim();
                        if (trimmed === '' || trimmed.toLowerCase() === 'null' || trimmed.toLowerCase() === 'na') {
                            return null;
                        }
                        const num = parseFloat(trimmed);
                        return isNaN(num) ? 0 : num;
                    });
                    
                    if (values.length === variables.length) {
                        data.push(values);
                    }
                }
                
                return { variables, data };
            },
            
            applyTransformation() {
                if (!this.currentData) {
                    this.showNotification('Primero carga un dataset', 'warning');
                    return;
                }
                
                this.showLoading('Aplicando transformación...');
                
                try {
                    const config = {
                        transformType: document.getElementById('transformType').value,
                        boxcoxLambda: parseFloat(document.getElementById('boxcoxLambda').value),
                        imputeMissing: document.getElementById('imputeMissing').value,
                        outlierMethod: document.getElementById('outlierMethod').value
                    };
                    
                    // Aplicar transformación
                    const transformed = this.transformer.transform(this.currentData.data, config);
                    
                    // Actualizar datos actuales
                    this.currentData.data = transformed;
                    
                    // Actualizar interfaz
                    this.updateTransformView();
                    this.updateOverviewStats();
                    
                    // Resetear PCA ya que los datos cambiaron
                    this.pca = null;
                    
                    // Cambiar a vista de transformación automáticamente
                    this.switchView('transform');
                    
                    const transformName = config.transformType === 'none' ? 'ninguna' : config.transformType;
                    this.showNotification(`Transformación "${transformName}" aplicada`, 'success');
                    
                } catch (error) {
                    console.error('Error:', error);
                    this.showNotification(`Error en transformación: ${error.message}`, 'error');
                } finally {
                    this.hideLoading();
                }
            },
            
            resetTransformation() {
                if (this.originalData) {
                    this.currentData = JSON.parse(JSON.stringify(this.originalData));
                    this.transformer.reset();
                    this.updateDataDisplay();
                    this.updateTransformView();
                    this.pca = null;
                    this.showNotification('Datos restaurados', 'info');
                }
            },
            
            calculatePCA() {
                if (!this.currentData || !this.currentData.data.length) {
                    this.showNotification('Primero carga un dataset', 'warning');
                    return;
                }
                
                this.showLoading('Calculando PCA...');
                
                setTimeout(() => {
                    try {
                        // Simulación de cálculo PCA (en un caso real, implementarías el algoritmo)
                        this.simulatePCA();
                        this.showNotification('PCA calculado exitosamente', 'success');
                    } catch (error) {
                        this.showNotification(`Error en PCA: ${error.message}`, 'error');
                    } finally {
                        this.hideLoading();
                    }
                }, 1500);
            },
            
            simulatePCA() {
                // Esta es una simulación - en un caso real implementarías el algoritmo PCA
                const nComponents = parseInt(document.getElementById('nComponents').value) || 3;
                const normalize = document.getElementById('normalize').value === 'true';
                
                // Datos simulados para demostración
                const varianceExplained = [45.2, 28.7, 15.3];
                const cumulativeVariance = [45.2, 73.9, 89.2];
                
                // Actualizar estadísticas
                document.getElementById('statComponents').textContent = nComponents;
                document.getElementById('statVariance').textContent = `${cumulativeVariance[nComponents-1] || 0}%`;
                
                // Actualizar gráficos
                this.updateVarianceChart(varianceExplained, cumulativeVariance);
                this.updateScatterPlot();
                
                // Actualizar tablas simuladas
                this.renderSimulatedLoadings();
                this.renderSimulatedHeatmap();
            },
            
            updateDataDisplay() {
                if (!this.currentData) return;
                
                // Actualizar estadísticas básicas
                document.getElementById('statSamples').textContent = this.currentData.data.length;
                
                // Renderizar tabla de datos
                this.renderDataTable();
                
                // Actualizar selectores de columnas
                this.updateColumnSelectors();
            },
            
            updateTransformView() {
                if (!this.currentData) return;
                
                const metadata = this.transformer.metadata;
                
                // Actualizar badges y estado
                const transformStatus = document.getElementById('transformStatus');
                const transformIndicator = document.getElementById('transformIndicator');
                
                if (metadata.active) {
                    transformStatus.textContent = 'ON';
                    transformStatus.className = 'transform-badge badge-improved';
                    transformIndicator.textContent = `Transformados (${metadata.type})`;
                    transformIndicator.className = 'transform-badge badge-improved';
                    document.getElementById('currentTransform').textContent = metadata.type;
                    document.getElementById('statTransform').textContent = metadata.type;
                } else {
                    transformStatus.textContent = 'OFF';
                    transformStatus.className = 'transform-badge badge-info';
                    transformIndicator.textContent = 'Datos originales';
                    transformIndicator.className = 'transform-badge badge-info';
                    document.getElementById('currentTransform').textContent = 'Ninguna';
                    document.getElementById('statTransform').textContent = 'Ninguna';
                }
                
                // Calcular estadísticas si están disponibles
                if (metadata.statsBefore && metadata.statsAfter) {
                    this.updateTransformStats(metadata.statsBefore, metadata.statsAfter);
                    this.renderTransformStatsTable(metadata.statsBefore, metadata.statsAfter);
                    this.updateComparisonChart();
                    this.updateDistributionChart();
                    this.updateImprovementChart(metadata.statsBefore, metadata.statsAfter);
                }
            },
            
            updateTransformStats(statsBefore, statsAfter) {
                if (!statsBefore || !statsAfter) return;
                
                // Calcular valores faltantes
                let missingCount = 0;
                statsBefore.forEach(stat => {
                    if (stat) missingCount += (stat.n - statBefore?.n || 0);
                });
                document.getElementById('statMissing').textContent = missingCount;
                
                // Calcular sesgo promedio
                const avgSkewnessBefore = statsBefore.reduce((sum, stat) => 
                    sum + (stat ? Math.abs(stat.skewness) : 0), 0) / statsBefore.length;
                const avgSkewnessAfter = statsAfter.reduce((sum, stat) => 
                    sum + (stat ? Math.abs(stat.skewness) : 0), 0) / statsAfter.length;
                
                document.getElementById('statSkewness').textContent = avgSkewnessAfter.toFixed(2);
                
                // Calcular curtosis promedio
                const avgKurtosisBefore = statsBefore.reduce((sum, stat) => 
                    sum + (stat ? Math.abs(stat.kurtosis) : 0), 0) / statsBefore.length;
                const avgKurtosisAfter = statsAfter.reduce((sum, stat) => 
                    sum + (stat ? Math.abs(stat.kurtosis) : 0), 0) / statsAfter.length;
                
                document.getElementById('statKurtosis').textContent = avgKurtosisAfter.toFixed(2);
            },
            
            updateOverviewStats() {
                // Actualizar estadísticas en vista general
                document.getElementById('statSamples').textContent = this.currentData.data.length;
            },
            
            updateColumnSelectors() {
                if (!this.currentData || !this.currentData.variables) return;
                
                const variables = this.currentData.variables;
                
                // Actualizar selectores
                const selectors = ['compareColumn', 'distColumn'];
                selectors.forEach(selectorId => {
                    const selector = document.getElementById(selectorId);
                    if (selector) {
                        selector.innerHTML = '';
                        variables.forEach((variable, i) => {
                            selector.innerHTML += `<option value="${i}">${variable}</option>`;
                        });
                    }
                });
            },
            
            renderDataTable() {
                const container = document.getElementById('dataTable');
                const data = this.currentData;
                
                if (!data || !data.data.length) {
                    container.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 20px;">No hay datos cargados</p>';
                    return;
                }
                
                const maxRows = 15;
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                ${data.variables.map(v => `<th>${v}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                for (let i = 0; i < Math.min(maxRows, data.data.length); i++) {
                    html += `
                        <tr>
                            <td style="font-weight: bold; color: #7f8c8d;">${i+1}</td>
                            ${data.data[i].map(val => {
                                if (val === null || val === undefined) {
                                    return '<td style="color: #e74c3c; font-style: italic;">null</td>';
                                }
                                return `<td>${typeof val === 'number' ? val.toFixed(4) : val}</td>`;
                            }).join('')}
                        </tr>
                    `;
                }
                
                html += `
                        </tbody>
                    </table>
                `;
                
                if (data.data.length > maxRows) {
                    html += `
                        <p style="margin-top: 10px; color: #7f8c8d; font-style: italic;">
                            <i class="fas fa-info-circle"></i> Mostrando ${maxRows} de ${data.data.length} filas
                        </p>
                    `;
                }
                
                container.innerHTML = html;
            },
            
            renderTransformStatsTable(statsBefore, statsAfter) {
                const container = document.getElementById('transformStatsTable');
                const variables = this.currentData.variables;
                
                if (!variables || !statsBefore || !statsAfter) {
                    container.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 20px;">No hay estadísticas disponibles</p>';
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Variable</th>
                                <th>Sesgo (Antes)</th>
                                <th>Sesgo (Después)</th>
                                <th>Curtosis (Antes)</th>
                                <th>Curtosis (Después)</th>
                                <th>Mejora</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                variables.forEach((variable, i) => {
                    const before = statsBefore[i];
                    const after = statsAfter[i];
                    
                    if (!before || !after) return;
                    
                    const skewnessDiff = Math.abs(after.skewness) - Math.abs(before.skewness);
                    const kurtosisDiff = Math.abs(after.kurtosis) - Math.abs(before.kurtosis);
                    
                    const improvement = (skewnessDiff < 0 && kurtosisDiff < 0) ? 'alta' :
                                       (skewnessDiff < 0 || kurtosisDiff < 0) ? 'media' : 'baja';
                    
                    const improvementClass = improvement === 'alta' ? 'badge-improved' : 
                                            improvement === 'media' ? 'badge-info' : 'badge-worse';
                    
                    html += `
                        <tr>
                            <td><strong>${variable}</strong></td>
                            <td>${before.skewness.toFixed(3)}</td>
                            <td style="font-weight: bold; color: ${Math.abs(after.skewness) < Math.abs(before.skewness) ? '#27ae60' : '#e74c3c'}">
                                ${after.skewness.toFixed(3)}
                            </td>
                            <td>${before.kurtosis.toFixed(3)}</td>
                            <td style="font-weight: bold; color: ${Math.abs(after.kurtosis) < Math.abs(before.kurtosis) ? '#27ae60' : '#e74c3c'}">
                                ${after.kurtosis.toFixed(3)}
                            </td>
                            <td><span class="transform-badge ${improvementClass}">${improvement.toUpperCase()}</span></td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table>`;
                container.innerHTML = html;
            },
            
            updateComparisonChart() {
                const ctx = document.getElementById('comparisonChart').getContext('2d');
                const colIndex = parseInt(document.getElementById('compareColumn').value) || 0;
                const metadata = this.transformer.metadata;
                
                if (!metadata.statsBefore || !metadata.statsAfter) return;
                
                const before = metadata.statsBefore[colIndex];
                const after = metadata.statsAfter[colIndex];
                
                if (!before || !after) return;
                
                if (this.charts.comparison) {
                    this.charts.comparison.destroy();
                }
                
                this.charts.comparison = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Media', 'Desv. Est.', 'Sesgo', 'Curtosis'],
                        datasets: [
                            {
                                label: 'Antes',
                                data: [
                                    before.mean,
                                    before.std,
                                    Math.abs(before.skewness),
                                    Math.abs(before.kurtosis)
                                ],
                                backgroundColor: 'rgba(231, 76, 60, 0.7)',
                                borderColor: '#e74c3c',
                                borderWidth: 1
                            },
                            {
                                label: 'Después',
                                data: [
                                    after.mean,
                                    after.std,
                                    Math.abs(after.skewness),
                                    Math.abs(after.kurtosis)
                                ],
                                backgroundColor: 'rgba(52, 152, 219, 0.7)',
                                borderColor: '#3498db',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            },
            
            updateDistributionChart() {
                const ctx = document.getElementById('distributionChart').getContext('2d');
                const colIndex = parseInt(document.getElementById('distColumn').value) || 0;
                const data = this.currentData.data;
                
                if (!data || data.length === 0) return;
                
                // Extraer columna seleccionada
                const values = data.map(row => row[colIndex]).filter(v => v !== null && !isNaN(v));
                
                if (values.length === 0) return;
                
                // Crear histograma
                const min = Math.min(...values);
                const max = Math.max(...values);
                const binCount = 10;
                const binWidth = (max - min) / binCount;
                
                const bins = Array(binCount).fill(0);
                values.forEach(val => {
                    const binIndex = Math.min(Math.floor((val - min) / binWidth), binCount - 1);
                    bins[binIndex]++;
                });
                
                if (this.charts.distribution) {
                    this.charts.distribution.destroy();
                }
                
                this.charts.distribution = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: bins.map((_, i) => {
                            const start = min + i * binWidth;
                            const end = start + binWidth;
                            return `${start.toFixed(1)}-${end.toFixed(1)}`;
                        }),
                        datasets: [{
                            label: 'Frecuencia',
                            data: bins,
                            backgroundColor: 'rgba(155, 89, 182, 0.7)',
                            borderColor: '#8e44ad',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Frecuencia'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: this.currentData.variables[colIndex]
                                }
                            }
                        }
                    }
                });
            },
            
            updateImprovementChart(statsBefore, statsAfter) {
                const ctx = document.getElementById('improvementChart').getContext('2d');
                
                if (!statsBefore || !statsAfter) return;
                
                const variables = this.currentData.variables;
                const skewnessImprovement = variables.map((_, i) => {
                    const before = statsBefore[i];
                    const after = statsAfter[i];
                    if (!before || !after) return 0;
                    return Math.abs(before.skewness) - Math.abs(after.skewness);
                });
                
                if (this.charts.improvement) {
                    this.charts.improvement.destroy();
                }
                
                this.charts.improvement = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: variables,
                        datasets: [{
                            label: 'Reducción de Sesgo (valor positivo = mejora)',
                            data: skewnessImprovement,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Reducción de Sesgo'
                                }
                            }
                        }
                    }
                });
            },
            
            updateVarianceChart(varianceExplained, cumulativeVariance) {
                const ctx = document.getElementById('varianceChart').getContext('2d');
                
                const labels = varianceExplained.map((_, i) => `PC${i+1}`);
                
                if (this.charts.variance) {
                    this.charts.variance.destroy();
                }
                
                this.charts.variance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Varianza Individual',
                                data: varianceExplained,
                                backgroundColor: '#e74c3c',
                                borderColor: '#c0392b',
                                borderWidth: 1
                            },
                            {
                                label: 'Varianza Acumulada',
                                data: cumulativeVariance,
                                type: 'line',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                borderColor: '#3498db',
                                borderWidth: 3,
                                pointBackgroundColor: '#3498db',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 6,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Varianza (%)'
                                }
                            }
                        }
                    }
                });
            },
            
            updateScatterPlot() {
                const ctx = document.getElementById('scatterChart').getContext('2d');
                
                // Datos simulados para scatter plot
                const scores = Array.from({length: 50}, () => [
                    Math.random() * 10 - 5,
                    Math.random() * 10 - 5,
                    Math.random() * 10 - 5
                ]);
                
                const xIndex = parseInt(document.getElementById('scatterX').value) || 0;
                const yIndex = parseInt(document.getElementById('scatterY').value) || 1;
                
                if (this.charts.scatter) {
                    this.charts.scatter.destroy();
                }
                
                this.charts.scatter = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Muestras',
                            data: scores.map((row, i) => ({
                                x: row[xIndex],
                                y: row[yIndex]
                            })),
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 1,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: `PC${xIndex + 1}`
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: `PC${yIndex + 1}`
                                }
                            }
                        }
                    }
                });
            },
            
            renderSimulatedLoadings() {
                const container = document.getElementById('loadingsTable');
                const variables = this.currentData.variables;
                const nComponents = parseInt(document.getElementById('nComponents').value) || 3;
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Variable</th>
                                ${Array.from({length: nComponents}, (_, i) => `<th>PC${i+1}</th>`).join('')}
                                <th>Comunalidad</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                variables.forEach((variable, i) => {
                    // Generar loadings aleatorios para demostración
                    const loadings = Array.from({length: nComponents}, () => 
                        (Math.random() * 2 - 1).toFixed(4)
                    );
                    
                    const communality = loadings.reduce((sum, val) => 
                        sum + Math.pow(parseFloat(val), 2), 0
                    ).toFixed(4);
                    
                    html += `
                        <tr>
                            <td><strong>${variable}</strong></td>
                            ${loadings.map(val => `
                                <td style="color: ${val >= 0 ? '#e74c3c' : '#3498db'}; font-weight: bold;">
                                    ${val}
                                </td>
                            `).join('')}
                            <td style="font-weight: bold; color: ${communality > 0.7 ? '#27ae60' : 
                                communality > 0.5 ? '#f39c12' : '#e74c3c'}">
                                ${communality}
                            </td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table>`;
                container.innerHTML = html;
            },
            
            renderSimulatedHeatmap() {
                const container = document.getElementById('heatmapContainer');
                const variables = this.currentData.variables;
                const nComponents = 3;
                
                let html = '<div class="heatmap-container">';
                
                // Encabezados
                html += '<div class="heatmap-cell var-header">Variable</div>';
                for (let i = 0; i < nComponents; i++) {
                    html += `<div class="heatmap-cell header">PC${i + 1}</div>`;
                }
                
                // Filas
                variables.forEach((variable, i) => {
                    html += `<div class="heatmap-cell var-header">${variable}</div>`;
                    
                    for (let j = 0; j < nComponents; j++) {
                        const value = (Math.random() * 2 - 1);
                        const intensity = Math.min(Math.abs(value) * 2, 1);
                        const hue = value >= 0 ? 0 : 240;
                        const color = `hsl(${hue}, 70%, ${70 - intensity * 40}%)`;
                        
                        html += `
                            <div class="heatmap-cell" style="background: ${color};">
                                ${value.toFixed(3)}
                            </div>
                        `;
                    }
                });
                
                html += '</div>';
                container.innerHTML = html;
            },
            
            exportData() {
                if (!this.currentData) return;
                
                const data = this.currentData;
                const csv = this.convertToCSV(data);
                this.downloadCSV(csv, 'datos_originales.csv');
                this.showNotification('Datos exportados', 'success');
            },
            
            exportTransformedData() {
                if (!this.currentData) return;
                
                const data = this.currentData;
                const csv = this.convertToCSV(data);
                this.downloadCSV(csv, 'datos_transformados.csv');
                this.showNotification('Datos transformados exportados', 'success');
            },
            
            convertToCSV(data) {
                let csv = data.variables.join(',') + '\n';
                
                data.data.forEach(row => {
                    csv += row.map(val => 
                        val === null ? '' : (typeof val === 'number' ? val.toFixed(6) : val)
                    ).join(',') + '\n';
                });
                
                return csv;
            },
            
            downloadCSV(csv, filename) {
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            
            switchView(viewName) {
                console.log('Cambiando a vista:', viewName);
                
                // Actualizar menú
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.view === viewName) {
                        item.classList.add('active');
                    }
                });
                
                // Mostrar vista
                document.querySelectorAll('.view').forEach(view => {
                    view.classList.remove('active');
                    if (view.id === `${viewName}View`) {
                        view.classList.add('active');
                    }
                });
                
                // Actualizar gráficos si es necesario
                if (viewName === 'transform' && this.transformer.metadata.active) {
                    this.updateTransformView();
                }
                
                // Si vamos a la vista de datos, actualizar la tabla
                if (viewName === 'data') {
                    this.renderDataTable();
                }
            },
            
            showLoading(message = 'Procesando...') {
                const loading = document.getElementById('loadingOverlay');
                const text = document.getElementById('loadingText');
                text.textContent = message;
                loading.classList.add('active');
            },
            
            hideLoading() {
                const loading = document.getElementById('loadingOverlay');
                loading.classList.remove('active');
            },
            
            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                const text = document.getElementById('notificationText');
                
                const colors = {
                    success: '#27ae60',
                    error: '#e74c3c',
                    warning: '#f39c12',
                    info: '#3498db'
                };
                
                notification.style.backgroundColor = colors[type] || colors.info;
                text.textContent = message;
                notification.style.display = 'flex';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        };
        
        // Iniciar aplicación
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
    <script src="javascript.js"></script>
</body>
</html>
